import javax.swing.JFrame;
import javax.swing.JPanel;
import javax.swing.border.EmptyBorder;
import java.awt.Color;
import javax.swing.JTabbedPane;
import javax.swing.JButton;
import javax.swing.JScrollPane;
import javax.swing.JSlider;
import java.awt.Dimension;
import java.awt.Graphics;
import java.awt.Graphics2D;

import javax.swing.SwingConstants;
import java.awt.SystemColor;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.event.MouseMotionListener;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.util.Random;

import javax.swing.JTable;
import javax.swing.table.DefaultTableModel;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.SAXException;

import javax.swing.JLabel;
import javax.swing.JToggleButton;
import javax.swing.UIManager;
import net.miginfocom.swing.MigLayout;
import javax.swing.border.TitledBorder;
import javax.swing.border.MatteBorder;
import java.awt.GridBagLayout;
import java.awt.GridBagConstraints;
import java.awt.Insets;
import javax.swing.JTextArea;
import javax.swing.ScrollPaneConstants;
import javax.swing.JTextField;
import javax.swing.event.ChangeListener;
import javax.swing.event.ChangeEvent;

@SuppressWarnings("serial")
public class DebugWindow extends JFrame {

	private JPanel contentPane;
	private JTable table;
	private DefaultTableModel table_model;
	private JSlider direction_slider;
	private JSlider speed_slider;
	private JTextField textField;
	private JTextField textField_1;
	private JTextField textField_2;
	public JTabbedPane tabbedPane_inputHelper;
	public JTextArea txtrInputCommandInfo;
	public TreePanel panel_tree;
	
	// Watched Variables getters and setters
	public int get_speed(){ return speed_slider.getValue(); }
	public int get_direction(){ return direction_slider.getValue(); }	
	
	public void set_speed(int speed){ 			  table_model.setValueAt(speed, 0, 1); }
	public void set_angle(int angle){ 			  table_model.setValueAt(angle, 1, 1); }
	public void set_distance(int distance){ 	  table_model.setValueAt(distance, 2, 1); }
	public void set_direction(int direction){ 	  table_model.setValueAt(direction, 3, 1); }
	public void set_temperature(int temperature){ table_model.setValueAt(temperature, 4, 1); }
	public void set_bumps(int bumps){	 		  table_model.setValueAt(bumps, 5, 1); }
	public void set_battery(int battery){ 		  table_model.setValueAt(battery, 6, 1); }

	// mouse panel variables
	public MousePanel panel_mouse_move;
	public volatile boolean panel_mouse_move_down = false;
	public volatile MouseEvent panel_mouse_move_event = null;
	
	
	// the windows main thread stuff
	private void window_thread_start() {
		
		new Thread( new Runnable() {
	        public void run()  {
	        	while(true){thread_run();}
	        }
		} ).start();
	}
	
	Random r = new Random();
	int pp = 0;
	@SuppressWarnings("static-access")
	private void thread_run() {
		
		if (pp<= 0) {
			Graphics2D g = panel_tree.get_g2();
			g.drawLine(0, r.nextInt(1000), panel_tree.getWidth(), panel_tree.getHeight());
			panel_tree.set_g2(g);
			pp = 10000;
			//g.dispose();
		}
		pp--;
		/////
		if (panel_mouse_move_down && panel_mouse_move_event != null) {
			int button = panel_mouse_move_event.getButton();
			
			boolean point_changed = false;
			if (button == panel_mouse_move_event.BUTTON1 || panel_mouse_move_event.getID() == panel_mouse_move_event.MOUSE_DRAGGED){//
				int mx = panel_mouse_move_event.getX();
				int my = panel_mouse_move_event.getY();
				int width = panel_mouse_move.getWidth()-10;
				int height = panel_mouse_move.getHeight()-10;
				int slide_x = (int) ((mx-(width/2.0))/((width/2.0)/100.0));
				int slide_y = (int) ((my-(height/2.0))/((height/2.0)/100.0));
				
				speed_slider.setValue(slide_y*-1);
				direction_slider.setValue(slide_x);
				
				panel_mouse_move.set_newPoint(mx-(width/2)-5, my-(height/2)-5);
				
				point_changed = true;
			}
			if (button == panel_mouse_move_event.BUTTON3) {
				direction_slider.setValue(0);
				speed_slider.setValue(0);
				panel_mouse_move.set_newPoint(0, 0);
				point_changed = true;
			}
			if (point_changed) {
				panel_mouse_move.repaint();
			}
		}
		
		
	}
	
	/**
	 * Create the frame.
	 */
	public DebugWindow() {
		
		//////////////////////////////////////////////////////////////////////////////////
		// set up the JFrame
		setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		setBounds(100, 100, 763, 601);

		//////////////////////////////////////////////////////////////////////////////////
		// set up the main JPanel
		contentPane = new JPanel();
		contentPane.setBorder(new EmptyBorder(5, 5, 5, 5));
		setContentPane(contentPane);
		contentPane.setLayout(null);

		//////////////////////////////////////////////////////////////////////////////////
		// Speed / Direction Remote
		JPanel panel = new JPanel();
		panel.setBorder(new TitledBorder(UIManager.getBorder("TitledBorder.border"), "Speed / Direction Remote", TitledBorder.LEADING, TitledBorder.TOP, null, new Color(0, 0, 0)));
		panel.setBackground(SystemColor.menu);
		panel.setBounds(12, 13, 200, 200);
		contentPane.add(panel);
		
		panel_mouse_move = new MousePanel();
		panel_mouse_move.addMouseListener(new MouseAdapter() {
            public void mousePressed(MouseEvent evt)  {panel_mouse_move_down = true; panel_mouse_move_event = evt;}
            public void mouseReleased(MouseEvent evt) {panel_mouse_move_down = false;}
            //public void mouseExited(MouseEvent evt)   {panel_mouse_move_down = false;}
		});
		panel_mouse_move.addMouseMotionListener(new MouseMotionListener() {
			@Override
			public void mouseMoved(MouseEvent evt) {}
			
			@Override
			public void mouseDragged(MouseEvent evt) { if (panel_mouse_move_down) { panel_mouse_move_event = evt; } }
			
		});
		
		panel.setLayout(new MigLayout("", "[][188px]", "[54px][54px][59px]"));
		panel_mouse_move.setBackground(Color.WHITE);
		panel.add(panel_mouse_move, "cell 1 0 1 2,grow");
		
		speed_slider = new JSlider();
		panel.add(speed_slider, "cell 0 0 1 2,grow");
		speed_slider.setSize(new Dimension(50, 50));
		speed_slider.setPaintTicks(true);
		speed_slider.setMinorTickSpacing(10);
		speed_slider.setMajorTickSpacing(50);
		speed_slider.setValue(0);
		speed_slider.setMinimum(-100);
		speed_slider.setOrientation(SwingConstants.VERTICAL);
		
		direction_slider = new JSlider();
		direction_slider.setSize(new Dimension(50, 50));
		direction_slider.setPaintTicks(true);
		direction_slider.setMinorTickSpacing(10);
		direction_slider.setMajorTickSpacing(50);
		direction_slider.setValue(0);
		direction_slider.setMinimum(-100);
		panel.add(direction_slider, "cell 1 2,grow");

		//////////////////////////////////////////////////////////////////////////////////
		JPanel panel_4 = new JPanel();
		panel_4.setBorder(new TitledBorder(null, "Watched Variables", TitledBorder.LEADING, TitledBorder.TOP, null, null));
		panel_4.setBounds(11, 226, 200, 289);
		contentPane.add(panel_4);
		GridBagLayout gbl_panel_4 = new GridBagLayout();
		gbl_panel_4.columnWidths = new int[] {184};
		gbl_panel_4.rowHeights = new int[] {0, 112};
		gbl_panel_4.columnWeights = new double[]{0.0};
		gbl_panel_4.rowWeights = new double[]{0.0, 0.0};
		panel_4.setLayout(gbl_panel_4);
		
		table = new JTable();
		table.setRowHeight(20);
		table.setGridColor(SystemColor.inactiveCaption);
		table.setIntercellSpacing(new Dimension(4, 4));
		table.setBackground(UIManager.getColor("InternalFrame.minimizeIconBackground"));
		table.setEnabled(false);
		table.setBorder(new MatteBorder(1, 1, 1, 1, (Color) SystemColor.inactiveCaption));
		table.setModel(new DefaultTableModel(
			new Object[][] {
				{"Speed", null},
				{"Angle", null},
				{"Distance", null},
				{"Direction", null},
				{"Temperature", null},
				{"Bumps", null},
				{"Battery", null},
			},
			new String[] {
				"Propertie", "value"
			}
		));
		table.getColumnModel().getColumn(0).setPreferredWidth(89);
		GridBagConstraints gbc_table = new GridBagConstraints();
		gbc_table.anchor = GridBagConstraints.NORTH;
		gbc_table.fill = GridBagConstraints.HORIZONTAL;
		gbc_table.insets = new Insets(0, 0, 5, 0);
		gbc_table.gridx = 0;
		gbc_table.gridy = 0;
		panel_4.add(table, gbc_table);
		table_model = (DefaultTableModel) table.getModel();

		//////////////////////////////////////////////////////////////////////////////////
		// the main tab body of the app
		JTabbedPane tabbedPane = new JTabbedPane(JTabbedPane.TOP);
		tabbedPane.setBounds(234, 13, 500, 538);
		contentPane.add(tabbedPane);

		//////////////////////////////////////////////////////////////////////////////////
		// Controller tab
		JPanel panel_3 = new JPanel();
		tabbedPane.addTab("Controller", null, panel_3, null);
		panel_3.setLayout(null);
		
		// the Manual Control button
		JToggleButton tglbtnNewToggleButton = new JToggleButton("Manual Control");
		tglbtnNewToggleButton.setBounds(10, 11, 170, 38);
		panel_3.add(tglbtnNewToggleButton);
		
		JLabel lblManualControlMust = new JLabel("Manual control must be on to send commands");
		lblManualControlMust.setBounds(190, 23, 284, 14);
		panel_3.add(lblManualControlMust);
		
		/////////////////////////////////////
		JPanel panel_5 = new JPanel();
		panel_5.setBorder(new TitledBorder(null, "Input Helper", TitledBorder.LEADING, TitledBorder.TOP, null, null));
		panel_5.setBounds(10, 60, 464, 233);
		panel_3.add(panel_5);
		panel_5.setLayout(null);
		
		textField = new JTextField();
		textField.setEditable(false);
		textField.setBounds(10, 199, 345, 23);
		panel_5.add(textField);
		textField.setColumns(10);
		
		JButton btnNewButton = new JButton("Send");
		btnNewButton.setBounds(365, 199, 89, 23);
		panel_5.add(btnNewButton);
		
		//
		
		txtrInputCommandInfo = new JTextArea();
		txtrInputCommandInfo.setAutoscrolls(false);
		txtrInputCommandInfo.setLineWrap(true);
		txtrInputCommandInfo.setRows(8);
		txtrInputCommandInfo.setTabSize(4);
		txtrInputCommandInfo.setWrapStyleWord(true);
		
		tabbedPane_inputHelper = new JTabbedPane(JTabbedPane.LEFT);
		tabbedPane_inputHelper.setTabLayoutPolicy(JTabbedPane.SCROLL_TAB_LAYOUT);
		tabbedPane_inputHelper.setBounds(10, 15, 263, 173);
		panel_5.add(tabbedPane_inputHelper);
		tabbedPane_inputHelper.addChangeListener(new ChangeListener() {
			public void stateChanged(ChangeEvent arg0) {
				String tab_name = tabbedPane_inputHelper.getTitleAt(tabbedPane_inputHelper.getSelectedIndex());
				txtrInputCommandInfo.setText(get_doc(tab_name.toLowerCase()));
			}
		});
		
		JScrollPane scrollPane_Drive = new JScrollPane();
		scrollPane_Drive.setHorizontalScrollBarPolicy(ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);
		tabbedPane_inputHelper.addTab("Drive", null, scrollPane_Drive, null);
		
		JPanel panel_driveInput = new JPanel();
		panel_driveInput.setBackground(SystemColor.window);
		scrollPane_Drive.setViewportView(panel_driveInput);
		
		JScrollPane scrollPane_Clean = new JScrollPane();
		tabbedPane_inputHelper.addTab("Clean", null, scrollPane_Clean, null);
		
		JPanel panel_cleanInput = new JPanel();
		panel_cleanInput.setBackground(SystemColor.window);
		scrollPane_Clean.setViewportView(panel_cleanInput);
		
		JScrollPane scrollPane_Reset = new JScrollPane();
		tabbedPane_inputHelper.addTab("Reset", null, scrollPane_Reset, null);
		
		JPanel panel_resetInput = new JPanel();
		panel_resetInput.setBackground(SystemColor.window);
		scrollPane_Reset.setViewportView(panel_resetInput);
		
		JScrollPane scrollPane_LEDs = new JScrollPane();
		tabbedPane_inputHelper.addTab("LEDs", null, scrollPane_LEDs, null);
		
		JPanel panel_LEDInput = new JPanel();
		panel_LEDInput.setBackground(SystemColor.window);
		scrollPane_LEDs.setViewportView(panel_LEDInput);
		
		JScrollPane scrollPane_Buttons = new JScrollPane();
		tabbedPane_inputHelper.addTab("Buttons", null, scrollPane_Buttons, null);
		
		JPanel panel_buttonsInput = new JPanel();
		panel_buttonsInput.setBackground(SystemColor.window);
		scrollPane_Buttons.setViewportView(panel_buttonsInput);
		
		JScrollPane scrollPane_Song = new JScrollPane();
		tabbedPane_inputHelper.addTab("Song", null, scrollPane_Song, null);
		
		JPanel panel_songInput = new JPanel();
		panel_songInput.setBackground(SystemColor.window);
		scrollPane_Song.setViewportView(panel_songInput);
		
		JScrollPane scrollPane_Sensors = new JScrollPane();
		tabbedPane_inputHelper.addTab("Sensors", null, scrollPane_Sensors, null);
		
		JPanel panel_sensorsInput = new JPanel();
		panel_sensorsInput.setBackground(SystemColor.window);
		scrollPane_Sensors.setViewportView(panel_sensorsInput);
		
		JScrollPane scrollPane = new JScrollPane();
		scrollPane.setBounds(283, 15, 171, 173);
		panel_5.add(scrollPane);
		scrollPane.setHorizontalScrollBarPolicy(ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);
		scrollPane.setVerticalScrollBarPolicy(ScrollPaneConstants.VERTICAL_SCROLLBAR_ALWAYS);
		scrollPane.setViewportView(txtrInputCommandInfo);

		JLabel lblDocumentation = new JLabel("Documentation");
		lblDocumentation.setHorizontalAlignment(SwingConstants.CENTER);
		scrollPane.setColumnHeaderView(lblDocumentation);

		/////////////////////////////////////
		JPanel panel_6 = new JPanel();
		panel_6.setLayout(null);
		panel_6.setBorder(new TitledBorder(UIManager.getBorder("TitledBorder.border"), "Raw Output", TitledBorder.LEADING, TitledBorder.TOP, null, new Color(0, 0, 0)));
		panel_6.setBounds(10, 304, 464, 91);
		panel_3.add(panel_6);
		
		JButton button = new JButton("Send");
		button.setBounds(365, 57, 89, 23);
		panel_6.add(button);
		
		JLabel lblPleaseLookAt = new JLabel("Please look at all documentation before using the Raw Output method.");
		lblPleaseLookAt.setBounds(10, 66, 345, 14);
		panel_6.add(lblPleaseLookAt);
		
		textField_1 = new JTextField();
		textField_1.setBounds(10, 21, 444, 25);
		panel_6.add(textField_1);
		textField_1.setColumns(10);

		/////////////////////////////////////
		JPanel panel_7 = new JPanel();
		panel_7.setLayout(null);
		panel_7.setBorder(new TitledBorder(UIManager.getBorder("TitledBorder.border"), "Sensor Input", TitledBorder.LEADING, TitledBorder.TOP, null, new Color(0, 0, 0)));
		panel_7.setBounds(10, 406, 464, 93);
		panel_3.add(panel_7);
		
		textField_2 = new JTextField();
		textField_2.setBounds(66, 17, 388, 20);
		panel_7.add(textField_2);
		textField_2.setColumns(10);
		
		JLabel lblRaw = new JLabel("Raw");
		lblRaw.setBounds(10, 20, 46, 14);
		panel_7.add(lblRaw);
		
		JButton btnTurnOff = new JButton("Turn Off");
		btnTurnOff.setBounds(12, 526, 200, 25);
		contentPane.add(btnTurnOff);

		//////////////////////////////////////////////////////////////////////////////////
		// tree tab
		panel_tree = new TreePanel();
		panel_tree.setBackground(Color.LIGHT_GRAY);
		tabbedPane.addTab("Tree", null, panel_tree, null);
		
		//////////////////////////////////////////////////////////////////////////////////
		setVisible(true);
		
		//
		window_thread_start();
	}
	
	private String get_doc(String id) {
		String filename = "docs/documentation.xml";
		try {
			DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
			DocumentBuilder db = dbf.newDocumentBuilder(); 
			Document doc = db.parse(new File(filename));
			
			doc.getDocumentElement().normalize();
			//System.out.println("Root element :" + doc.getDocumentElement().toString());
			NodeList nList = doc.getElementsByTagName("doc");
			for (int i = 0; i < nList.getLength(); i++) {
				Node nNode = nList.item(i);
				//System.out.println("\nCurrent Element :" + nNode.getNodeName());
				if (nNode.getNodeType() == Node.ELEMENT_NODE) {
					Element eElement = (Element) nNode;
					if (eElement.getAttribute("id").compareTo(id) == 0) {
						return eElement.getElementsByTagName("text").item(0).getTextContent();
					}
				}
			}
		} catch (SAXException | IOException | ParserConfigurationException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
        
		return "";
	}

	private class MousePanel extends JPanel {
		
		int point_x = 0;
		int point_y = 0;
		int point_size = 10;
		
		public MousePanel(){
			super();
		}
		
		public void set_newPoint(int x, int y) {
			point_x = x;
			point_y = y;
		}
		
		public void paintComponent(Graphics g) {
			super.paintComponent(g);  
			
			int cx = this.getWidth()/2;
			int cy = this.getHeight()/2;
			
			int px = cx+point_x-point_size/2;
			int py = cy+point_y-point_size/2;
			
			g.drawOval(px, py, point_size, point_size);
		}
	}

	private class TreePanel extends JPanel {
		BufferedImage image;
		Graphics2D g2 = null;
		public int width;
		public int height;
		
		public TreePanel(){
			super();
			image = new BufferedImage(1000, 1000, BufferedImage.TYPE_INT_ARGB);
			g2 = image.createGraphics();
			
			width = this.getWidth();
			height = this.getHeight();
		}
		
		public Graphics2D get_g2(){
			return g2;
		}
		public void set_g2(Graphics2D g){
			g2 = g;
			this.repaint();
		}
		
		
		public void paintComponent(Graphics g) {
			Graphics2D gg2 = (Graphics2D) g;
			super.paintComponent(g);
			gg2.drawImage(image, null, 0, 0);
			
			gg2.dispose();
			g2.clearRect(0, 0, 1000, 1000);;
		}
	}
}
